@page "/cart"
@inject ICartService CartService
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Authorization

<MudText Typo="Typo.h3" Class="mb-4" Style="font-family: 'Exo 2'">MISSION GEAR</MudText>

<AuthorizeView>
    <Authorized>
        @if (cartItems == null)
        {
            <MudProgressCircular Indeterminate="true" Color="Color.Secondary" />
        }
        else if (!cartItems.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="my-4">
                No equipment requisitioned.
            </MudAlert>
            <MudButton Href="/" Variant="Variant.Text" Color="Color.Secondary">Return to Store</MudButton>
        }
        else
        {
            <MudTable Items="@cartItems" Hover="true" Elevation="0" Style="background: transparent;">
                <HeaderContent>
                    <MudTh>Equipment</MudTh>
                    <MudTh>Unit Cost</MudTh>
                    <MudTh>Quantity</MudTh>
                    <MudTh>Total</MudTh>
                    <MudTh></MudTh>
                </HeaderContent>
                <RowTemplate Context="item">
                    <MudTd DataLabel="Game">
                        <div class="d-flex align-center">
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <MudImage Src="@item.ImageUrl" Width="80" Class="rounded mr-3" />
                            }
                            <MudText>@item.Title</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Price" Style="color: #FF9800;">$@item.Price</MudTd>
                    <MudTd DataLabel="Quantity">
                        <MudChip T="string" Variant="Variant.Outlined" Color="Color.Primary">@item.Quantity</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Total" Style="font-weight: bold;">$@(item.Price* item.Quantity)</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" Size="Size.Small"
                            OnClick="@(() => UpdateQty(item, 1))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" Color="Color.Error" Size="Size.Small"
                            OnClick="@(() => UpdateQty(item, -1))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <div class="d-flex justify-end align-center mt-8 pa-4" Style="background: #141414; border: 1px solid #333;">
                <MudText Typo="Typo.h5" Class="mr-6">TOTAL: <span style="color: #FF9800;">$@cartItems.Sum(x => x.Price *
                                            x.Quantity)</span></MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large" Href="/checkout"
                Style="font-weight: bold; padding: 10px 30px;">
                AUTHORIZE PURCHASE
            </MudButton>
        </div>
                }
    </Authorized>

    <NotAuthorized>
        <MudPaper Class="pa-16 d-flex flex-column align-center justify-center" Elevation="0"
            Style="background: #141414; border: 1px dashed #333;">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Secondary" Class="mb-4"
                Style="font-size: 4rem;" />
            <MudText Typo="Typo.h5" GutterBottom="true">Access Restricted</MudText>
            <MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">Authentication required to access
                requisition manifest.</MudText>

            <MudButton Href="/login" Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Large"
                StartIcon="@Icons.Material.Filled.Login">
                LOGIN TO VIEW CART
            </MudButton>
        </MudPaper>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<CartItemDto>? cartItems;

    // Use OnAfterRenderAsync to handle the logic safely
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // We only attempt to load if we think we are authorized,
            // but the AuthorizeView handles the UI switching for us.
            // We can safely try to load; if it fails/returns empty, the AuthView will likely hide it anyway
            // or we just show empty.
            try
            {
                await LoadCart();
                StateHasChanged();
            }
            catch { /* Ignore errors, likely auth related */ }
        }
    }

    private async Task LoadCart()
    {
        cartItems = await CartService.GetCartAsync();
    }

    private async Task UpdateQty(CartItemDto item, int change)
    {
        var newQty = item.Quantity + change;
        if (newQty < 0) return;

        await CartService.UpdateQuantityAsync(item.GameId, newQty);
        await LoadCart();
        StateHasChanged();
    }
}